
<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pomodoro timer</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0f1c;--panel:#0e1626;--muted:#cbd5e1;--text:#ffffff;--accent:#34d399;--danger:#ef4444;--stroke:#475569;--primary:#60a5fa;
      --focus-color-border:#16a34a;--focus-color-bg:#052e2b;
      --break-color-border:#60a5fa;--break-color-bg:#0b1430
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,Noto Sans,sans-serif;background:radial-gradient(1400px 900px at 70% -10%,#12213c 0%, var(--bg) 60%);color:var(--text);color-scheme:dark}
    .wrap{max-width:1040px;margin:0 auto;padding:24px}
    .grid{display:grid;gap:16px}
    .panel{position:relative;background:rgba(14,22,38,.96);border:1px solid var(--stroke);border-radius:20px;padding:16px;backdrop-filter:blur(8px);box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .timer{display:flex;align-items:center;justify-content:center;flex-direction:column;gap:18px;padding:36px 16px;border-radius:20px}
    .time{font-variant-numeric:tabular-nums;letter-spacing:1px;font-size:64px;font-weight:700;color:#fff;font-family:"JetBrains Mono",monospace}
    .status{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    button,input,select,textarea{font:inherit;color:inherit}
    button{border:1px solid var(--stroke);background:#0b1220;color:#fff;padding:11px 14px;border-radius:12px;cursor:pointer;transition:transform .06s ease, box-shadow .2s ease}
    button:hover{box-shadow:0 0 0 3px rgba(96,165,250,.25)}
    button:active{transform:translateY(1px)}
    button.primary{border-color:#1e3a8a;background:#102141}
    button.warn{border-color:#4c1d1d;background:#1b0e0e}
    .field{display:flex;flex-direction:column;gap:6px;min-width:140px}
    label{font-size:12px;color:#f1f5f9;font-weight:700}
    input[type=text],input[type=number],input[type=date],select,textarea{
      -webkit-appearance:none;appearance:none;caret-color:#fff;
      border:1px solid var(--stroke);background:#0f1117;color:#e6e6e6;border-radius:12px;padding:10px;box-shadow:none
    }
    select, option{color:#fff;background:#0f1117}
    input::placeholder, textarea::placeholder{color:#9aa0a6;opacity:1}
    input:disabled{color:#e5e7eb;background:#0f172a;border-color:#64748b}
    input:focus,select:focus,textarea:focus{outline:2px solid rgba(96,165,250,.5);border-color:#60a5fa}
    textarea{min-height:120px;resize:vertical}
    .small{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--stroke);padding:10px;text-align:left;vertical-align:top}
    th{color:#f1f5f9;font-weight:700;font-size:12px}
    .pill{padding:4px 10px;border:1px solid var(--stroke);border-radius:999px;color:#e2e8f0;font-size:12px;letter-spacing:.2px;transition:background .15s ease,border-color .15s ease}
    .pill.focus{border-color:var(--focus-color-border);background:var(--focus-color-bg)}
    .pill.break{border-color:var(--break-color-border);background:var(--break-color-bg)}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55)}
    .modal.show{display:flex}
    .sheet{width:min(1000px,96vw);background:#0b1220;border:1px solid var(--stroke);border-radius:20px;padding:16px}
    .sheet h3{margin:0 0 8px 0}
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    .footer{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:12px}
    .error{color:#fca5a5;font-size:12px}
    .viz{position:absolute;inset:0;border-radius:20px;overflow:hidden}
    canvas#viz{position:absolute;inset:0;width:100%;height:100%;filter:drop-shadow(0 0 24px rgba(52,211,153,.25))}
    @media (max-width:600px){.time{font-size:48px}}
  </style>
</head>
<body>
  <div class="wrap grid">
    <div class="panel timer" role="region" aria-label="Pomodoro timer">
      <div class="viz"><canvas id="viz"></canvas></div>
      <div class="row" style="align-items:center;width:100%;position:relative;z-index:1">
        <div class="pill focus" id="modePill">focus</div>
        <div class="small" id="cycleInfo"></div>
        <div class="right small">spatie start pauze • enter opslaan • <span class="pill">skip = test einde</span></div>
      </div>
      <div class="time" id="time" style="position:relative;z-index:1">00:00</div>
      <div class="status" id="status" style="position:relative;z-index:1">klaar</div>
      <div class="row" style="position:relative;z-index:1">
        <button id="startBtn" class="primary">start</button>
        <button id="pauseBtn">pauze</button>
        <button id="resetBtn">reset</button>
        <button id="skipBtn" class="warn" title="test: rond huidige fase direct af">skip</button>
      </div>
      <div class="row" aria-label="instellingen" style="position:relative;z-index:1">
        <div class="field">
          <label for="focusMin">focus minuten</label>
          <input id="focusMin" type="number" min="5" max="180" step="1" value="40" />
        </div>
        <div class="field">
          <label for="breakMin">pauze minuten</label>
          <input id="breakMin" type="number" min="1" max="60" step="1" value="10" />
        </div>
        <div class="field">
          <label for="autoStart">auto start</label>
          <select id="autoStart">
            <option value="focus">na pauze start focus</option>
            <option value="break">na focus start pauze</option>
            <option value="none" selected>geen</option>
          </select>
        </div>
        <div class="field">
          <label for="copyOnSave">kopieer notitie bij opslaan</label>
          <select id="copyOnSave">
            <option value="markdown">markdown</option>
            <option value="csv">csv (notes)</option>
            <option value="no" selected>uit</option>
          </select>
        </div>
        <div class="field">
          <label for="soundToggle">geluid</label>
          <select id="soundToggle">
            <option value="on" selected>aan</option>
            <option value="off">uit</option>
          </select>
        </div>
      </div>
    </div>

    <div class="panel" role="region" aria-label="lijsten beheren">
      <div class="row" style="align-items:flex-start;justify-content:space-between;gap:12px">
        <div class="field" style="flex:1">
          <label for="subjectSelect">onderwerpen (dropdown)</label>
          <select id="subjectSelect" multiple size="5" style="min-width:240px"></select>
          <div class="row">
            <input id="newSubject" placeholder="nieuw onderwerp" />
            <button id="addSubject">toevoegen</button>
            <button id="removeSelected">verwijder selectie</button>
          </div>
        </div>
        <div class="field" style="flex:1">
          <label for="categorySelect">categorieën (dropdown)</label>
          <select id="categorySelect" multiple size="5" style="min-width:240px"></select>
          <div class="row">
            <input id="newCategory" placeholder="nieuwe categorie" />
            <button id="addCategory">toevoegen</button>
            <button id="removeCategories">verwijder selectie</button>
          </div>
        </div>
      </div>
      <div class="small">deze lijsten worden gebruikt in het notitieformulier. lokaal opgeslagen.</div>
    </div>

    <div class="panel" role="region" aria-label="log">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="small">log van focusblokken</div>
        <div class="row">
          <button id="downloadNotesCsv">download notes csv</button>
          <button id="downloadTasksCsv">download taken csv</button>
          <button id="copyNotesCsv">kopieer notes csv</button>
          <button id="copyTasksCsv">kopieer taken csv</button>
          <button id="copyAllMd">kopieer alle als markdown</button>
          <button id="clearLog" class="warn">wis log</button>
        </div>
      </div>
      <div style="overflow:auto">
        <table id="logTable" aria-label="logtabel">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Titel</th>
              <th>Onderwerp</th>
              <th>Categorie</th>
              <th>Status</th>
              <th>Starttijd</th>
              <th>Eindtijd</th>
              <th>Duur min</th>
              <th>Taak?</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="small" id="hint">download maakt .csv • kopie is fallback voor sandbox/preview</div>
    </div>
  </div>

  <div class="modal" id="csvModal" aria-modal="true" role="dialog" aria-labelledby="csvTitle">
    <div class="sheet">
      <h3 id="csvTitle">csv voorbeeld</h3>
      <div class="field"><textarea id="csvText" style="min-height:220px"></textarea></div>
      <div class="footer">
        <button id="copyCsv">kopieer</button>
        <button id="closeCsv" class="primary">sluiten</button>
      </div>
    </div>
  </div>

  <div class="modal" id="noteModal" aria-modal="true" role="dialog" aria-labelledby="noteTitleLabel">
    <div class="sheet">
      <h3 id="noteTitleLabel">wat heb je gedaan in dit blok</h3>
      <div id="formError" class="error" aria-live="polite"></div>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
        <div class="field">
          <label for="noteTitle">titel *</label>
          <input id="noteTitle" placeholder="kort, bv les H3 herzien" />
        </div>
        <div class="field">
          <label for="noteSubject">onderwerp *</label>
          <select id="noteSubject"></select>
        </div>
        <div class="field">
          <label for="noteCategory">categorie *</label>
          <select id="noteCategory"></select>
        </div>
        <div class="field">
          <label for="noteStatus">status *</label>
          <select id="noteStatus">
            <option>Not started</option>
            <option>In progress</option>
            <option>On Hold</option>
            <option selected>Done</option>
          </select>
        </div>
        <div class="field">
          <label for="noteStart">start</label>
          <input id="noteStart" />
        </div>
        <div class="field">
          <label for="noteEnd">einde</label>
          <input id="noteEnd" />
        </div>
        <div class="field">
          <label for="noteDuration">duur</label>
          <input id="noteDuration" disabled />
        </div>
      </div>
      <div class="field" style="margin-top:10px">
        <label for="noteText">notitie *</label>
        <textarea id="noteText" placeholder="wat is af wat blijft open"></textarea>
      </div>
      <div class="panel" style="margin-top:12px">
        <div class="row" style="align-items:flex-end;gap:12px">
          <div class="field" style="min-width:120px">
            <label for="makeTask">maak ook een taak</label>
            <select id="makeTask">
              <option value="no" selected>nee</option>
              <option value="yes">ja</option>
            </select>
          </div>
          <div class="field" style="min-width:120px">
            <label for="taskPrio">prio (Q1–Q4)</label>
            <select id="taskPrio">
              <option></option>
              <option>Q1</option>
              <option>Q2</option>
              <option>Q3</option>
              <option>Q4</option>
            </select>
          </div>
          <div class="field" style="min-width:160px">
            <label for="taskDue">due handmatig</label>
            <input id="taskDue" type="date" />
            <div class="small">wordt geëxporteerd als dd/mm/jjjj</div>
          </div>
        </div>
      </div>
      <div class="footer">
        <span class="muted">enter opslaan • esc sluiten</span>
        <button id="cancelNote">sluiten</button>
        <button id="saveNote" class="primary">opslaan</button>
      </div>
    </div>
  </div>

  <script>
  ;(()=>{
    const els = {
      viz: document.getElementById('viz'),
      time: q('#time'), status: q('#status'), start: q('#startBtn'), pause: q('#pauseBtn'), reset: q('#resetBtn'), skip: q('#skipBtn'),
      focusMin: q('#focusMin'), breakMin: q('#breakMin'), autoStart: q('#autoStart'), copyOnSave: q('#copyOnSave'), soundToggle: q('#soundToggle'),
      modePill: q('#modePill'), cycleInfo: q('#cycleInfo'),
      subjectSelect: q('#subjectSelect'), newSubject: q('#newSubject'), addSubject: q('#addSubject'), removeSelected: q('#removeSelected'),
      categorySelect: q('#categorySelect'), newCategory: q('#newCategory'), addCategory: q('#addCategory'), removeCategories: q('#removeCategories'),
      logBody: q('#logTable tbody'), downloadNotesCsv: q('#downloadNotesCsv'), downloadTasksCsv: q('#downloadTasksCsv'), copyNotesCsv: q('#copyNotesCsv'), copyTasksCsv: q('#copyTasksCsv'), copyAllMd: q('#copyAllMd'), clearLog: q('#clearLog'), hint: q('#hint'),
      csvModal: q('#csvModal'), csvText: q('#csvText'), copyCsv: q('#copyCsv'), closeCsv: q('#closeCsv'),
      noteModal: q('#noteModal'), formError: q('#formError'), noteTitle: q('#noteTitle'), noteSubject: q('#noteSubject'), noteCategory: q('#noteCategory'), noteStatus: q('#noteStatus'),
      noteStart: q('#noteStart'), noteEnd: q('#noteEnd'), noteDuration: q('#noteDuration'), noteText: q('#noteText'), makeTask: q('#makeTask'), taskPrio: q('#taskPrio'), taskDue: q('#taskDue'),
      cancelNote: q('#cancelNote'), saveNote: q('#saveNote')
    };

    let state = {
      mode:'focus', running:false, endAt:null, startAt:null, remainingSec:null, timerId:null, cycle:0,
      logs: load('logs', []),
      subjects: load('subjects', ['lesontwerp','voorbereiding','klantwerk','administratie','lezen','schrijven','onderzoek','e-mail','reflectie']),
      categories: load('categories', ['Apply Advies','Apply Opleidingen','Studenten','Thoughts']),
      settings: load('settings', {focusMin:40, breakMin:10, autoStart:'none', copyOnSave:'no', sound:'on'})
    };

    let audioCtx = null;
    function getAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); return audioCtx; }
    async function playDing(){
      if(els.soundToggle.value==='off') return;
      const ctx = getAudio(); try{ await ctx.resume(); }catch{}
      const now = ctx.currentTime;
      for(let i=0;i<3;i++){
        const o = ctx.createOscillator(); const g = ctx.createGain(); o.type='sine';
        o.frequency.setValueAtTime(520 + i*100, now + i*0.18);
        o.frequency.linearRampToValueAtTime(820 + i*120, now + i*0.18 + 0.15);
        g.gain.setValueAtTime(0.0001, now + i*0.18);
        g.gain.exponentialRampToValueAtTime(0.25, now + i*0.18 + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, now + i*0.18 + 0.18);
        o.connect(g).connect(ctx.destination);
        o.start(now + i*0.18); o.stop(now + i*0.18 + 0.2);
      }
    }

    function init(){
      on(document,'keydown', onKey);
      on(els.start,'click', start); on(els.pause,'click', pause); on(els.reset,'click', reset); on(els.skip,'click', skipPhase);
      on(els.focusMin,'change', onSettingChange); on(els.breakMin,'change', onSettingChange); on(els.autoStart,'change', onSettingChange); on(els.copyOnSave,'change', onSettingChange); on(els.soundToggle,'change', onSettingChange);
      on(els.addSubject,'click', addSubject); on(els.removeSelected,'click', removeSubjects); on(els.addCategory,'click', addCategory); on(els.removeCategories,'click', removeCategories);
      on(els.downloadNotesCsv,'click', ()=>downloadCSV('notes')); on(els.downloadTasksCsv,'click', ()=>downloadCSV('tasks'));
      on(els.copyNotesCsv,'click', ()=>copyCSV('notes')); on(els.copyTasksCsv,'click', ()=>copyCSV('tasks')); on(els.copyAllMd,'click', ()=>copy(textAllMarkdown())); on(els.clearLog,'click', clearLog);
      on(els.cancelNote,'click', hideNote); on(els.saveNote,'click', saveEntry);
      on(els.noteText,'keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); saveEntry(); }});
      on(els.noteSubject,'keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); saveEntry(); }});
      on(els.copyCsv,'click', ()=>copy(els.csvText.value)); on(els.closeCsv,'click', ()=>els.csvModal.classList.remove('show'));

      els.focusMin.value = state.settings.focusMin; els.breakMin.value = state.settings.breakMin; els.autoStart.value = state.settings.autoStart; els.copyOnSave.value = state.settings.copyOnSave; els.soundToggle.value = state.settings.sound;
      renderSubjectList(); renderCategoryList(); renderLog(); setMode('focus'); setTimeDisplay(state.settings.focusMin*60); setStatus('klaar');

      startViz();
    }

    function q(sel){ return document.querySelector(sel); }
    function on(el,ev,fn){ el.addEventListener(ev,fn); }

    function onKey(e){
      const tag = (e.target||{}).tagName;
      if(tag==='INPUT' || tag==='TEXTAREA' || tag==='SELECT'){
        if(e.key==='Escape') hideNote();
        return;
      }
      if(e.code==='Space'){ e.preventDefault(); state.running ? pause() : start(); }
    }

    function onSettingChange(){
      state.settings.focusMin = clamp(els.focusMin.value,5,180);
      state.settings.breakMin = clamp(els.breakMin.value,1,60);
      state.settings.autoStart = els.autoStart.value;
      state.settings.copyOnSave = els.copyOnSave.value;
      state.settings.sound = els.soundToggle.value;
      save('settings', state.settings);
      if(!state.running){ setTimeDisplay((state.mode==='focus'? state.settings.focusMin:state.settings.breakMin)*60); }
    }

    function clamp(v,min,max){ v=parseInt(v||0,10); return Math.max(min, Math.min(max, v)); }
    function setStatus(t){ els.status.textContent=t }
function setTimeDisplay(sec){
  const m = Math.floor(sec/60).toString().padStart(2,'0');
  const s = Math.floor(sec%60).toString().padStart(2,'0');
  els.time.textContent = `${m}:${s}`;
  document.title = `${els.time.textContent} • ${state.mode}`;
}

    function setMode(mode){
      state.mode=mode;
      els.modePill.textContent=mode;
      els.modePill.className = 'pill ' + mode;
      els.hint.textContent=mode==='focus'?'log toont alleen focusblokken':'pauze loopt. geen logging';
      els.cycleInfo.textContent='cyclus '+state.cycle;
    }

    function start(){
      if(state.running) return; const now=new Date(); const durMs=(state.mode==='focus'?state.settings.focusMin:state.settings.breakMin)*60*1000;
      if(state.remainingSec!=null){ state.endAt=new Date(Date.now()+state.remainingSec*1000); } else { state.startAt=now; state.endAt=new Date(now.getTime()+durMs); }
      state.running=true; tick(); state.timerId=setInterval(tick,250); setStatus(state.mode==='focus'?'bezig met focus':'bezig met pauze');
    }
    function pause(){ if(!state.running) return; state.running=false; clearInterval(state.timerId); state.timerId=null; state.remainingSec=Math.max(0,Math.round((state.endAt-Date.now())/1000)); setStatus('gepauzeerd') }
    function reset(){ clearInterval(state.timerId); state.timerId=null; state.running=false; state.endAt=null; state.startAt=null; state.remainingSec=null; setTimeDisplay((state.mode==='focus'?state.settings.focusMin:state.settings.breakMin)*60); setStatus('klaar') }

    function skipPhase(){
      if(state.mode==='focus'){
        if(!state.running){ state.startAt=new Date(Date.now()-state.settings.focusMin*60*1000); state.endAt=new Date(); }
        clearTick(); onPhaseEnd();
      }else{ clearTick(); nextMode('focus'); if(state.settings.autoStart==='focus') start(); }
    }

    function clearTick(){ clearInterval(state.timerId); state.timerId=null; state.running=false; state.remainingSec=null }
    function tick(){ const ms=state.endAt-Date.now(); const sec=Math.max(0,Math.round(ms/1000)); setTimeDisplay(sec); if(ms<=0){ clearTick(); onPhaseEnd(); } }

    function onPhaseEnd(){
      playDing();
      if(state.mode==='focus'){
        showNote();
      }else{
        nextMode('focus'); if(state.settings.autoStart==='focus') start();
      }
    }
    function nextMode(target){ setMode(target); state.startAt=null; state.endAt=null; state.remainingSec=null; setTimeDisplay((target==='focus'?state.settings.focusMin:state.settings.breakMin)*60); setStatus('klaar') }

    function showNote(){
      const start = state.startAt ? state.startAt : new Date(Date.now() - state.settings.focusMin*60*1000);
      const end = new Date(); const durMin = diffMin(start,end);
      els.noteStart.value = fmtLocal(start); els.noteEnd.value = fmtLocal(end); els.noteDuration.value = durMin + ' min';
      buildDropdowns(); els.noteTitle.value=''; els.noteText.value=''; els.makeTask.value='no'; els.taskPrio.value=''; els.taskDue.value='';
      els.formError.textContent=''; els.noteModal.classList.add('show'); els.noteTitle.focus();
    }
    function hideNote(){ els.noteModal.classList.remove('show'); }

    function buildDropdowns(){
      els.noteSubject.innerHTML=''; state.subjects.forEach(s=>{ const o=doc('option'); o.value=s; o.textContent=s; els.noteSubject.appendChild(o); });
      els.noteCategory.innerHTML=''; state.categories.forEach(c=>{ const o=doc('option'); o.value=c; o.textContent=c; els.noteCategory.appendChild(o); });
      const last=state.logs[state.logs.length-1]; if(last){ els.noteSubject.value=last.subject; els.noteCategory.value=last.category; els.noteStatus.value=last.status || 'Done'; }
    }

    function saveEntry(){
      const err = [];
      const title = els.noteTitle.value.trim(); if(!title) err.push('titel');
      const subject = els.noteSubject.value.trim(); if(!subject) err.push('onderwerp');
      const category = els.noteCategory.value.trim(); if(!category) err.push('categorie');
      const status = els.noteStatus.value.trim(); if(!status) err.push('status');
      const notes = els.noteText.value.trim(); if(!notes) err.push('notitie');
      if(err.length){ els.formError.textContent = 'Vul in: ' + err.join(', '); return; }

      const start = parseLocal(els.noteStart.value); const end = parseLocal(els.noteEnd.value);
      const entry = {
        date: fmtDMY(start), start: fmtLocal(start), end: fmtLocal(end), durationMin: diffMin(start,end),
        title, subject, category, status, notes,
        makeTask: (els.makeTask.value==='yes'), prio: els.taskPrio.value || '', dueManual: els.taskDue.value ? dmyFromISO(els.taskDue.value) : '' , type:'focus'
      };
      state.logs.push(entry); save('logs', state.logs); appendLogRow(entry);

      if(state.settings.copyOnSave!=='no'){
        const text = state.settings.copyOnSave==='markdown' ? textMarkdown([entry]) : buildNotesCSV([entry]);
        copy(text);
      }

      hideNote(); state.cycle += 1; nextMode('break'); if(state.settings.autoStart==='break') start();
    }

    function renderSubjectList(){ els.subjectSelect.innerHTML=''; state.subjects.forEach(s=>{ const o=doc('option'); o.value=s; o.textContent=s; els.subjectSelect.appendChild(o); }); }
    function renderCategoryList(){ els.categorySelect.innerHTML=''; state.categories.forEach(c=>{ const o=doc('option'); o.value=c; o.textContent=c; els.categorySelect.appendChild(o); }); }
    function addSubject(){ const v=(els.newSubject.value||'').trim(); if(!v) return; if(!state.subjects.includes(v)){ state.subjects.push(v); save('subjects',state.subjects); renderSubjectList(); } els.newSubject.value=''; }
    function removeSubjects(){ const selected=Array.from(els.subjectSelect.selectedOptions).map(o=>o.value); if(!selected.length) return; state.subjects=state.subjects.filter(s=>!selected.includes(s)); save('subjects',state.subjects); renderSubjectList(); }
    function addCategory(){ const v=(els.newCategory.value||'').trim(); if(!v) return; if(!state.categories.includes(v)){ state.categories.push(v); save('categories',state.categories); renderCategoryList(); } els.newCategory.value=''; }
    function removeCategories(){ const selected=Array.from(els.categorySelect.selectedOptions).map(o=>o.value); if(!selected.length) return; state.categories=state.categories.filter(c=>!selected.includes(c)); save('categories',state.categories); renderCategoryList(); }

    function renderLog(){ els.logBody.innerHTML=''; state.logs.forEach(appendLogRow); }
    function appendLogRow(e){ const tr=doc('tr'); tr.innerHTML=('<td>'+esc(e.date)+'</td><td>'+esc(e.title)+'</td><td>'+esc(e.subject)+'</td><td>'+esc(e.category)+'</td><td>'+esc(e.status)+'</td><td>'+esc(e.start)+'</td><td>'+esc(e.end)+'</td><td>'+e.durationMin+'</td><td>'+(e.makeTask?'ja':'')+'</td>'); els.logBody.appendChild(tr); }
    function clearLog(){ if(!confirm('log wissen')) return; state.logs=[]; save('logs',state.logs); renderLog(); }

    function buildNotesCSV(items){
      const head = 'Titel,Notitie,Onderwerp,Categorie,Status,Datum,Starttijd,Eindtijd,Duur min';
      const rows = items.map(e=>[ e.title, e.notes, e.subject, e.category, e.status, e.date, e.start, e.end, e.durationMin ].map(csvCell).join(','));
      return [head, ...rows].join('\r\n');
    }
    function buildTasksCSV(items){
      const tasks = items.filter(e=>e.makeTask);
      const head = 'Task,Categorie,Onderwerp,Notitie,Status,Prio,Due handmatig';
      const rows = tasks.map(e=>[ e.title, e.category, e.subject, e.notes, e.status, e.prio, e.dueManual ].map(csvCell).join(','));
      return [head, ...rows].join('\r\n');
    }
    function downloadCSV(kind){
      try{
        const text = (kind==='tasks')? buildTasksCSV(state.logs) : buildNotesCSV(state.logs);
        const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        const stamp = new Date().toISOString().slice(0,10);
        a.download = (kind==='tasks'? 'tasks_'+stamp+'.csv' : 'notes_'+stamp+'.csv');
        document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
      }catch{
        openCsvModal((kind==='tasks')? buildTasksCSV(state.logs) : buildNotesCSV(state.logs));
      }
    }
    function copyCSV(kind){ const text = (kind==='tasks')? buildTasksCSV(state.logs) : buildNotesCSV(state.logs); copy(text); }
    function openCsvModal(text){ els.csvText.value = text; els.csvModal.classList.add('show'); els.csvText.select(); }

    function textAllMarkdown(){ return textMarkdown(state.logs); }
    function textMarkdown(items){ return items.map(e=>'- '+e.date+' '+e.start+'-'+e.end+' | '+e.title+' | '+e.subject+' | '+e.durationMin+'m | '+e.notes).join('\n'); }
    function csvCell(v){ const s=(v==null?'':String(v)); return '"'+s.replace(/"/g,'""')+'"'; }

    function fmtLocal(d){ const pad=n=>String(n).padStart(2,'0'); return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+' '+pad(d.getHours())+':'+pad(d.getMinutes()) }
    function parseLocal(s){ const parts=String(s).split(' '); const dm=parts[0].split('-').map(n=>parseInt(n,10)); const tm=(parts[1]||'00:00').split(':').map(n=>parseInt(n,10)); return new Date(dm[0],dm[1]-1,dm[2],tm[0],tm[1]) }
    function fmtDMY(d){ const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear(); return dd+'/'+mm+'/'+yy }
    function dmyFromISO(iso){ if(!iso) return ''; const p=iso.split('-'); return p[2]+'/'+p[1]+'/'+p[0]; }
    function diffMin(a,b){ return Math.max(0, Math.round((b-a)/60000)); }
    function esc(s){ return (s||'').replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
    function doc(t){ return document.createElement(t); }
    function copy(text){ navigator.clipboard.writeText(text).then(()=>{ els.hint.textContent='gekopieerd'; setTimeout(()=>els.hint.textContent='download maakt .csv • kopie is fallback voor sandbox/preview', 1200); }).catch(()=>{ openCsvModal(text); }); }
    function save(k,v){ localStorage.setItem('pomo_'+k, JSON.stringify(v)); }
    function load(k,d){ try{ return JSON.parse(localStorage.getItem('pomo_'+k)) ?? d }catch{ return d } }

    function startViz(){
      const canvas = els.viz; const ctx = canvas.getContext('2d');
      function resize(){ const dpr=window.devicePixelRatio||1; canvas.width = canvas.clientWidth*dpr; canvas.height = canvas.clientHeight*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); }
      resize(); window.addEventListener('resize', resize);
      let t=0;
      (function raf(){ t+=0.016; draw(ctx, t); requestAnimationFrame(raf); })();
      function draw(ctx, t){
        const w=canvas.clientWidth, h=canvas.clientHeight; ctx.clearRect(0,0,w,h);
        ctx.fillStyle='rgba(3,7,18,0.35)'; ctx.fillRect(0,0,w,h);
        const cx=w/2, cy=h/2; const baseR=Math.min(w,h)*0.36;
        const total = (state.mode==='focus'? state.settings.focusMin : state.settings.breakMin)*60;
        const remaining = getRemainingSec();
        const prog = total? Math.max(0, Math.min(1, remaining/total)) : 0;
        const hue = state.mode==='focus' ? 150 : 205;
        for(let i=0;i<7;i++){
          const r = baseR*(0.2 + i*0.12);
          const sides = 3 + (i%5);
          const rot = t*(0.3 + i*0.07) * (i%2?1:-1) + prog*Math.PI*2*(i*0.03);
          const alpha = 0.12 + 0.06*i;
          ctx.strokeStyle = 'hsla('+(hue + i*6)+', 80%, '+(55 - i*4)+'%,'+alpha+')';
          ctx.lineWidth = 1 + (i===6?2:1);
          polygonPath(ctx, cx, cy, r, sides, rot);
          ctx.stroke();
          ctx.beginPath();
          for(let k=0;k<sides;k++){
            const a = rot + k*(Math.PI*2/sides);
            const rr = r*(0.6 + 0.35*Math.sin(t*0.9 + i + k));
            const x = cx + rr*Math.cos(a), y = cy + rr*Math.sin(a);
            ctx.moveTo(x+1,y); ctx.arc(x,y,1.2,0,Math.PI*2);
          }
          ctx.fillStyle = 'hsla('+(hue + 40)+', 90%, 70%, '+(0.15 + 0.05*i)+')'; ctx.fill();
        }
        ctx.beginPath(); ctx.arc(cx, cy, baseR*0.85, -Math.PI/2, -Math.PI/2 + (1-prog)*Math.PI*2);
        ctx.strokeStyle = 'hsla('+(hue+20)+', 95%, 70%, .7)'; ctx.lineWidth=4; ctx.stroke();
      }
      function polygonPath(ctx, x, y, r, n, rot){ ctx.beginPath(); for(let i=0;i<n;i++){ const a = rot + i*(Math.PI*2/n); const px = x + r*Math.cos(a), py = y + r*Math.sin(a); if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);} ctx.closePath(); }
    }

    function getRemainingSec(){ if(state.running && state.endAt){ return Math.max(0, Math.round((state.endAt - Date.now())/1000)); } const sec = state.mode==='focus'? state.settings.focusMin*60 : state.settings.breakMin*60; return sec; }

    init();
  })();
  </script>
</body>
</html>
